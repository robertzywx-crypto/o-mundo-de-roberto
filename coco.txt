%%javascript
// RPG "O MUNDO DE ROBERTO" - C√ìDIGO JAVASCRIPT PURO
// Este c√≥digo foi extra√≠do do HTML e deve ser carregado AP√ìS o carregamento do DOM (Document Object Model).

// -----------------------------
// Estado do jogador
// -----------------------------
const player = {
    nome: "Roberto",
    classe: "Espadachim",
    vida: 40,
    maxVida: 40,
    mana: 20,
    maxMana: 20,
    ataque: 7,
    magia: 10,
    nivel: 1
};

// -----------------------------
// Limites M√°ximos (CAPS) DEFINIDOS PELO JOGADOR
// -----------------------------
const LIMITES = {
    MAX_LEVEL: 50,
    MAX_VIDA: 7000,
    MAX_MANA: 75
};

// -----------------------------
// Magias
// -----------------------------
const magias = {
    "Golpe Flamejante": 20,
    "Corte Congelante": 18,
    "Rajada Sombria": 25
};

// -----------------------------
// Cidades e monstros (CHEFE FINAL: LORDE DAS TREVAS) - HIST√ìRIAS APRIMORADAS
// -----------------------------
const cidades = {
    Frostvale: {
        // Hist√≥ria Aprimorada
        historia: "Frostvale ‚Äì A Cidade do Gelo. Um v√©u de escurid√£o e ventos cortantes envolve esta terra. O sol se foi h√° anos, e os moradores murmuram sobre uma criatura alada no topo das Montanhas Sombrias que congela a pr√≥pria esperan√ßa. O ar aqui √© pesado, indicando que os servos do mal est√£o pr√≥ximos.",
        monstros: [
            {nome:"Lobo de Gelo", vida:90},
            {nome:"Golem Congelado", vida:135}
        ],
        chefe: {nome:"Drag√£o Branco Glacial", vida:250},
        // Hist√≥ria P√≥s-Chefe Aprimorada
        historiaPosChefe: "‚ùÑÔ∏è O uivo ensurdecedor do **Drag√£o Branco Glacial** se cala, e um sil√™ncio g√©lido, mas pac√≠fico, toma conta de Frostvale. O gelo quebrou! Uma luz p√°lida surge no horizonte: o sol brilha pela primeira vez em d√©cadas. No covil do drag√£o, voc√™ encontra um **Mapa Estelar Antigo**, revelando a verdadeira teia de poder do Lorde das Trevas. A cidade est√° salva, e a pr√≥xima pista foi revelada. (Recompensa: N√≠vel Up)"
    },
    Oakheart: {
        // Hist√≥ria Aprimorada
        historia: "Oakheart ‚Äì A Cidade das Florestas. √Årvores colossais tentam tocar o c√©u, mas uma energia p√∫trida corrompe a vida. Os Ents, outrora guardi√µes pac√≠ficos, viraram criaturas furiosas. O Guardi√£o Ancestral, que protege o Cora√ß√£o da Floresta, foi pervertido. O ar cheira a musgo antigo e decad√™ncia.",
        monstros: [
            {nome:"Goblin Verde", vida:75},
            {nome:"Ent da Floresta", vida:150}
        ],
        chefe: {nome:"Guardi√£o Ancestral Corrompido", vida:300},
        // Hist√≥ria P√≥s-Chefe Aprimorada
        historiaPosChefe: "üå≥ O **Guardi√£o Ancestral Corrompido** desmorona, e sua casca se dissolve em part√≠culas de luz verdejante que curam a floresta instantaneamente. A vida explode ao seu redor, e um esp√≠rito da natureza (uma dr√≠ade) emerge do tronco. Ela, grata pela liberta√ß√£o, te concede uma **Ess√™ncia de Mana Pura** (Sentindo um grande aumento em sua capacidade m√°gica). Sua jornada √© mais importante do que voc√™ imagina. (Recompensa: N√≠vel Up)"
    },
    Emberforge: {
        // Hist√≥ria Aprimorada
        historia: "Emberforge ‚Äì A Cidade do Fogo, incrustada na base de um vulc√£o ativo. O calor √© insuport√°vel, mas n√£o √© natural; √© o poder opressor de um Tit√£. Os ferreiros est√£o escravizados, for√ßando-os a criar armas para o mal. O ch√£o treme a cada passo. A forja da resist√™ncia est√° quase extinta.",
        monstros: [
            {nome:"Salamandra de Fogo", vida:105},
            {nome:"Basilisco Flamejante", vida:165}
        ],
        chefe: {nome:"Tit√£ de Magma Implac√°vel", vida:400},
        // Hist√≥ria P√≥s-Chefe Aprimorada
        historiaPosChefe: "üî• O grito de dor do **Tit√£ de Magma Implac√°vel** √© o √∫ltimo som antes que o vulc√£o se acalme. O calor opressor diminui para uma brisa quente. Os ferreiros, libertos, te erguem em triunfo. Eles prometem que, quando voc√™ retornar vitorioso sobre o mal final, eles forjar√£o para voc√™ a **Armadura de Roberto, a Lenda**. Voc√™ sente sua **for√ßa e resist√™ncia interior** serem forjadas, preparando-o para o pr√≥ximo desafio. (Recompensa: N√≠vel Up)"
    },
    Stormreach: {
        // Hist√≥ria Aprimorada
        historia: "Stormreach ‚Äì Cidade das Tempestades. Aqui, os trov√µes n√£o s√£o um fen√¥meno clim√°tico, mas o rugido de um drag√£o aprisionado que domina o c√©u. Chuvas violentas e rel√¢mpagos cont√≠nuos impedem qualquer comunica√ß√£o. O poder el√©trico √© palp√°vel e perigoso. O vilarejo √© uma casca de sua antiga gl√≥ria, dominada pelo caos elementar.",
        monstros: [
            {nome:"Elemental de Trov√£o", vida:120},
            {nome:"Raio Errante", vida:180}
        ],
        chefe: {nome:"Drag√£o El√©trico do C√©u", vida:360},
        // Hist√≥ria P√≥s-Chefe Aprimorada
        historiaPosChefe: "‚ö° O √∫ltimo estrondo trovejante do **Drag√£o El√©trico do C√©u** se apaga, e as nuvens se separam, revelando um c√©u estrelado. Um anci√£o s√°bio da cidade, que havia se escondido, emerge e explica que o drag√£o era uma fonte de energia ca√≥tica. Agora que est√° livre, a energia deve ser contida. Voc√™, Roberto, absorve a **Ess√™ncia de Trov√£o**, sentindo um aumento dr√°stico em sua **velocidade e reflexos**. O caminho para o covil final est√° se abrindo. (Recompensa: N√≠vel Up)"
    },
    Shadowfen: {
        // Hist√≥ria Aprimorada
        historia: "Shadowfen ‚Äì O P√¢ntano das Sombras. Este √© o covil final, onde a pr√≥pria luz √© sugada. A aura do mal supremo √© palp√°vel, tornando o ar denso e frio. A escurid√£o aguarda para extinguir a luz de Roberto. O caminho √© trai√ßoeiro e cada passo pode ser seu √∫ltimo. O **Lorde das Trevas** est√° al√©m, esperando.",
        monstros: [
            {nome:"Sapo Gigante", vida:90},
            {nome:"Serpente Sombria", vida:150}
        ],
        // REQUISITO: O LORDE DAS TREVAS
        chefe: {nome:"Lorde das Trevas: O Aniquilador", vida:5000},
        // Hist√≥ria P√≥s-Chefe Aprimorada
        historiaPosChefe: "üëë **VOC√ä √â O CAMPE√ÉO DE CANAD√Å MEDIEVAL!** üëë<br><br>O 'Lorde das Trevas' se desintegra em uma poeira c√≥smica fria, e o sil√™ncio que se segue n√£o √© de medo, mas de uma paz ancestral. A escurid√£o que cobria o Canad√° Medieval por √©ons √© finalmente rasgada, substitu√≠da por um brilho quente e dourado. Voc√™, **Roberto, o Espadachim**, completou o imposs√≠vel e reescreveu o destino. Voc√™ n√£o apenas salvou o reino, mas acendeu uma nova era de luz. Seu nome ser√° cantado em baladas por s√©culos. **PARAB√âNS! O MUNDO DE ROBERTO EST√Å SALVO!**"
    },
    "O Vazio": {
        // Hist√≥ria Aprimorada
        historia: "O Vazio ‚Äì O centro da cria√ß√£o, um lugar al√©m do tempo e espa√ßo. O ar aqui n√£o √© ar, mas a pr√≥pria ess√™ncia de uma realidade estilha√ßada. As leis da f√≠sica se dobram, e ecos do tempo passado e futuro flutuam. O Criador, em sua forma mais irada e incompreens√≠vel, espera para reverter toda a sua jornada.",
        monstros: [
            {nome:"G√°rgula de Realidade", vida:200},
            {nome:"Ecos do Tempo", vida:300}
        ],
        chefe: {nome:"O Criador do Vazio", vida:800},
        // Hist√≥ria P√≥s-Chefe Aprimorada
        historiaPosChefe: "‚ú® Com a derrota d'O Criador do Vazio, a pr√≥pria tape√ßaria da realidade se estabiliza. N√£o h√° gritos de vit√≥ria, apenas a sensa√ß√£o de um universo reajustado. Voc√™, Roberto, transcendeu o hero√≠smo comum; voc√™ restaurou o equil√≠brio fundamental entre a cria√ß√£o e a aniquila√ß√£o. Sua lenda ecoar√° para sempre, n√£o apenas no Canad√° Medieval, mas atrav√©s de todas as dimens√µes. **FIM DE JOGO! Voc√™ √© uma entidade lend√°ria!**"
    },
    Aethelburg: {
        // Hist√≥ria Aprimorada
        historia: "Aethelburg ‚Äì A Capital. Um farol de esperan√ßa no Canad√° Medieval, lar da Grande Biblioteca e do Conselho Real. Aqui, os sinos dobram em um ritmo calmo. √â seu ref√∫gio seguro, o √∫nico lugar onde o mal n√£o ousou pisar. Use este tempo para se curar e buscar conhecimento sobre seus pr√≥ximos passos.",
        monstros: [],
        chefe: null,
        historiaPosChefe: null
    }
};

// -----------------------------
// Estado do combate
// -----------------------------
let inimigoAtual = null;
let filaMonstros = [];
let chefeAtual = null;
let cidadeAtual = null;
let emHistoria = false;

// -----------------------------
// Vari√°veis de Refer√™ncia (Declaradas fora da fun√ß√£o de inicializa√ß√£o)
// -----------------------------
let out, btnAtk, btnMag, btnDef, btnFugir, btnMapa, mapaDiv;


// -----------------------------
// Fun√ß√£o Principal: Inicia o Jogo ap√≥s o carregamento do DOM
// -----------------------------
function iniciarJogo() {
    // -----------------------------
    // Refer√™ncias HTML (S√≥ s√£o seguras ap√≥s o carregamento do DOM)
    // -----------------------------
    out = document.getElementById("output");
    btnAtk = document.getElementById("atkBtn");
    btnMag = document.getElementById("magBtn");
    btnDef = document.getElementById("defBtn");
    btnFugir = document.getElementById("fugirBtn");
    btnMapa = document.getElementById("voltarBtn");
    mapaDiv = document.getElementById("mapa");

    // -----------------------------
    // Associa Eventos de Clique
    // -----------------------------
    btnAtk.onclick = atacar;
    btnMag.onclick = magia;
    btnDef.onclick = defender;
    btnFugir.onclick = fugir;
    btnMapa.onclick = mostrarMapa;

    // -----------------------------
    // L√≥gica de Inicializa√ß√£o
    // -----------------------------
    limpar();

    log("=========================================");
    log("=== BEM-VINDO AO MUNDO DE ROBERTO! ===");
    log("=========================================");
    log("<br>");

    log(`üìà **LIMITES DO HER√ìI:** N√≠vel M√°ximo: ${LIMITES.MAX_LEVEL} | Vida M√°xima: ${LIMITES.MAX_VIDA} | Mana M√°xima: ${LIMITES.MAX_MANA}`);
    log("‚ö†Ô∏è O Lorde das Trevas exige poder m√°ximo. Suba de n√≠vel para sobreviver!");
    log("<br>");

    log("‚ùÑÔ∏è Este √© o **Canad√° Medieval**, uma terra vasta de gelo, florestas antigas e magia indom√°vel.");
    log("‚öîÔ∏è Sua miss√£o, Roberto, o Espadachim Lend√°rio, √© libertar a terra e derrotar os tiranos.");
    log("üëë Seu ponto de partida √© Aethelburg, a Capital pac√≠fica.");
    log("üó∫Ô∏è Use o bot√£o 'Mapa' para come√ßar sua jornada!");
    log("<br>");

    mostraStatus();
    desabilitarBotoesCombate();
}


// -----------------------------
// Fun√ß√µes utilit√°rias
// -----------------------------
function log(msg){
    out.insertAdjacentHTML('beforeend', msg + "<br>");
    out.scrollTop = out.scrollHeight;
}

function limpar(){
    out.innerHTML = "";
}

function mostraStatus(){
    log(`üë§ ${player.nome} ‚Äî LVL ${player.nivel}/${LIMITES.MAX_LEVEL} | Vida: ${player.vida}/${player.maxVida} | Mana: ${player.mana}/${player.maxMana}`);
}

function habilitarBotoesCombate(){
    btnAtk.disabled = false;
    btnMag.disabled = false;
    btnDef.disabled = false;
    btnFugir.disabled = false;
    mapaDiv.innerHTML = "";
}

function desabilitarBotoesCombate(){
    btnAtk.disabled = true;
    btnMag.disabled = true;
    btnDef.disabled = true;
    btnFugir.disabled = true;
}

// -----------------------------
// FUN√á√ÉO DE PROGRESS√ÉO (COM VERIFICA√á√ÉO DE LIMITE/CAP)
// -----------------------------
function subirNivel(){

    // Verifica se j√° atingiu o n√≠vel m√°ximo
    if (player.nivel >= LIMITES.MAX_LEVEL) {
        log("‚úÖ N√≠vel m√°ximo (LVL 50) alcan√ßado! N√£o h√° mais progress√£o de n√≠vel.");
        // Cura e restaura mesmo no cap
        player.vida = player.maxVida;
        player.mana = player.maxMana;
        mostraStatus();
        return;
    }

    player.nivel++;

    let aumentoVida = Math.max(1, Math.round(player.maxVida * 0.10));
    let aumentoMana = Math.max(1, Math.round(player.maxMana * 0.05));

    // Aplica o CAP de Vida
    player.maxVida = Math.min(LIMITES.MAX_VIDA, player.maxVida + aumentoVida);
    if (player.maxVida === LIMITES.MAX_VIDA) {
        aumentoVida = LIMITES.MAX_VIDA - (player.maxVida - aumentoVida);
    }

    // Aplica o CAP de Mana
    player.maxMana = Math.min(LIMITES.MAX_MANA, player.maxMana + aumentoMana);
    if (player.maxMana === LIMITES.MAX_MANA) {
        aumentoMana = LIMITES.MAX_MANA - (player.maxMana - aumentoMana);
    }

    // Cura total
    player.vida = player.maxVida;
    player.mana = player.maxMana;

    log(`üåü **PARAB√âNS!** Voc√™ subiu para o N√≠vel ${player.nivel}!`);
    log(`‚¨ÜÔ∏è +${aumentoVida} Max Vida | +${aumentoMana} Max Mana.`);
    mostraStatus();
}

// -----------------------------
// Gerencia a pausa e a continua√ß√£o da hist√≥ria
// -----------------------------
function continuarHistoria(){
    emHistoria = false;
    limpar();

    // Condi√ß√£o especial para o Chefe Final
    if (cidadeAtual === "Shadowfen" || cidadeAtual === "O Vazio") {
        log("üéâ FIM DO JOGO! A LENDA DE ROBERTO FOI ESCRITA!");
        desabilitarBotoesCombate();
        btnMapa.disabled = true;
        mapaDiv.innerHTML = "Fim de Jogo. Parab√©ns!";
        return;
    }

    log(`üèÜ ${cidadeAtual} conquistada! Voc√™ est√° pronto para explorar outra cidade.`);
    mostrarMapa();
}


// -----------------------------
// Combate
// -----------------------------
function iniciarCombate(monstro){
    inimigoAtual = {...monstro};
    limpar();
    log(`‚öîÔ∏è Voc√™ encontrou ${inimigoAtual.nome} (Vida: ${inimigoAtual.vida})`);
    mostraStatus();
    habilitarBotoesCombate();
}

function inimigoAtaca(){
    let dano = 0;
    let acao = "atacou";

    if (inimigoAtual.nome === "Lorde das Trevas: O Aniquilador") {
        if (Math.random() < 0.4) {
            dano = 1000;
            acao = "lan√ßou Magia da Aniquila√ß√£o (1000)";
        } else {
            dano = 500;
            acao = "desferiu Golpe Sombrio (500)";
        }
    } else {
        dano = Math.floor(Math.random() * 8) + 3;
    }

    player.vida -= dano;
    log(`üí• ${inimigoAtual.nome} ${acao} e causou ${dano} de dano!`);

    if(player.vida <= 0){
        log("üíÄ Voc√™ foi derrotado... O mundo de Roberto escurece.");
        desabilitarBotoesCombate();
        return;
    }
    mostraStatus();
}

function atacar(){
    if(!inimigoAtual || emHistoria) return;
    const dano = Math.floor(Math.random() * 5) + player.ataque;
    inimigoAtual.vida -= dano;
    log(`üó°Ô∏è Voc√™ atacou ${inimigoAtual.nome} e causou ${dano} de dano!`);
    if(inimigoAtual.vida <= 0){
        log(`üéâ Voc√™ derrotou ${inimigoAtual.nome}!`);
        subirNivel();
        nextMonstro(false, inimigoAtual.nome);
        return;
    }
    inimigoAtaca();
}

function magia(){
    if(!inimigoAtual || emHistoria) return;
    if(player.mana < 5){
        log("‚ùå Mana insuficiente!");
        return;
    }
    const keys = Object.keys(magias);
    const magiaEscolhida = keys[Math.floor(Math.random()*keys.length)];
    const dano = magias[magiaEscolhida];
    player.mana -= 5;
    inimigoAtual.vida -= dano;
    log(`‚ú® Voc√™ usou ${magiaEscolhida} e causou ${dano} de dano!`);
    if(inimigoAtual.vida <= 0){
        log(`üéâ Voc√™ derrotou ${inimigoAtual.nome}!`);
        subirNivel();
        nextMonstro(false, inimigoAtual.nome);
        return;
    }
    inimigoAtaca();
}

function defender(){
    if(!inimigoAtual || emHistoria) return;

    log(`üõ°Ô∏è Voc√™ se defendeu!`);

    let danoBase = 0;
    if (inimigoAtual.nome === "Lorde das Trevas: O Aniquilador") {
        danoBase = 500;
    } else {
        danoBase = Math.floor(Math.random() * 8) + 3;
    }

    const reducaoEfetiva = inimigoAtual.nome === "Lorde das Trevas: O Aniquilador" ? 50 : 5;

    const danoFinal = Math.max(0, danoBase - reducaoEfetiva);

    player.vida -= danoFinal;

    log(`üõ°Ô∏è ${inimigoAtual.nome} atacou. Defesa ativada, voc√™ recebeu ${danoFinal} de dano.`);
    if(player.vida <= 0){
        log("üíÄ Voc√™ foi derrotado...");
        desabilitarBotoesCombate();
        return;
    }
    mostraStatus();
}

function fugir(){
    if(!inimigoAtual || emHistoria) return;
    if(Math.random() < 0.5){
        log("üèÉ Voc√™ fugiu com sucesso!");
        desabilitarBotoesCombate();
        nextMonstro(true);
    } else {
        log("‚ùå Fuga falhou!");
        inimigoAtaca();
    }
}


// -----------------------------
// Sequ√™ncia de monstros
// -----------------------------
function nextMonstro(fugiu=false, nomeInimigoDerrotado=null){

    const infoCidade = cidades[cidadeAtual];
    const eraChefe = infoCidade.chefe && nomeInimigoDerrotado === infoCidade.chefe.nome;

    if(filaMonstros.length > 0){
        iniciarCombate(filaMonstros.shift());

    } else if(infoCidade.chefe && chefeAtual && !fugiu){
        log("‚ö†Ô∏è Um CHEF√ÉO apareceu!");
        iniciarCombate(chefeAtual);
        chefeAtual = null;

    } else if (eraChefe && infoCidade.historiaPosChefe) {

        emHistoria = true;
        desabilitarBotoesCombate();

        log("--- FIM DA BATALHA ---");
        log(`üëë **${nomeInimigoDerrotado} derrotado!**`);
        log("<br>");
        log(infoCidade.historiaPosChefe);
        log("<br>");

        const btnContinuar = document.createElement("button");
        btnContinuar.textContent = (cidadeAtual === "Shadowfen" || cidadeAtual === "O Vazio") ? "Finalizar Jogo" : "Continuar Jornada >";
        btnContinuar.onclick = continuarHistoria;
        mapaDiv.innerHTML = "";
        mapaDiv.appendChild(btnContinuar);

    } else {
        log(`üèÜ ${cidadeAtual} explorada! Voc√™ est√° pronto para explorar outra cidade.`);
        desabilitarBotoesCombate();
    }
}

// -----------------------------
// Cidades (Com l√≥gica para Aethelburg)
// -----------------------------
function visitarCidade(nome){
    limpar();
    cidadeAtual = nome;
    log(`üèôÔ∏è ${cidades[nome].historia}`);
    mostraStatus();

    if (nome === "Aethelburg") {
        log("üìú O velho bibliotec√°rio acena para voc√™.");
        log(" 'Bem-vindo, Roberto. Procure informa√ß√µes sobre as outras cidades no menu 'Mapa'.' ");
        desabilitarBotoesCombate();

        const btnDescansar = document.createElement("button");
        btnDescansar.textContent = "Descansar (HP/MP Full)";
        btnDescansar.onclick = () => {
            player.vida = player.maxVida;
            player.mana = player.maxMana;
            log("üíñ Voc√™ descansou e recuperou totalmente sua Vida e Mana!");
            mostraStatus();
        };
        mapaDiv.innerHTML = "";
        mapaDiv.appendChild(btnDescansar);

    } else {
        filaMonstros = [...cidades[nome].monstros];
        const bossData = cidades[nome].chefe;
        chefeAtual = bossData ? {...bossData} : null;
        nextMonstro();
    }
}

// -----------------------------
// Fun√ß√£o Mapa
// -----------------------------
function mostrarMapa() {
    limpar();
    log("üåç Escolha uma cidade para visitar:");
    mapaDiv.innerHTML = "";
    Object.keys(cidades).forEach(c => {
        const b = document.createElement("button");
        b.textContent = c;
        b.onclick = () => visitarCidade(c);
        mapaDiv.appendChild(b);
    });
}

// -----------------------------
// Inicializa√ß√£o Segura do JS
// -----------------------------
// Esta linha garante que a fun√ß√£o 'iniciarJogo' s√≥ rode ap√≥s o HTML estar pronto.
document.addEventListener('DOMContentLoaded', iniciarJogo);