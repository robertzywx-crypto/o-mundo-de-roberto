// -----------------------------
// RPG "O MUNDO DE MAGIA"
// -----------------------------

// -----------------------------
// Estado do jogador
// -----------------------------
const player = {
    nome: "isaac",
    classe: "Espadachim",
    vida: 40,
    maxVida: 40,
    mana: 20,
    maxMana: 20,
    ataque: 7,
    magia: 10,
    nivel: 1
};

// -----------------------------
// Limites M√°ximos
// -----------------------------
const LIMITES = {
    MAX_LEVEL: 50,
    MAX_VIDA: 5000,
    MAX_MANA: 75
};

// -----------------------------
// Magias
// -----------------------------
const magias = {
    "Golpe Flamejante": 20,
    "Corte Congelante": 18,
    "Rajada Sombria": 25
};

// -----------------------------
// Cidades
// -----------------------------
const cidades = {
    Frostvale: {
        historia: "Frostvale ‚Äì A Cidade do Gelo, com ventos cortantes e montanhas geladas.",
        monstros: [
            { nome: "Lobo de Gelo", vida: 90 },
            { nome: "Golem Congelado", vida: 135 }
        ],
        chefe: { nome: "Drag√£o Branco", vida: 250 },
        historiaPosChefe: "‚ùÑÔ∏è Frostvale est√° livre novamente."
    },
    Oakheart: {
        historia: "Oakheart ‚Äì A Cidade das Florestas.",
        monstros: [
            { nome: "Goblin Verde", vida: 75 },
            { nome: "Ent da Floresta", vida: 150 }
        ],
        chefe: { nome: "Guardi√£o Ancestral", vida: 300 },
        historiaPosChefe: "üå≥ Oakheart floresce outra vez."
    },
    Emberforge: {
        historia: "Emberforge ‚Äì A Cidade do Fogo.",
        monstros: [
            { nome: "Salamandra de Fogo", vida: 105 },
            { nome: "Basilisco Flamejante", vida: 165 }
        ],
        chefe: { nome: "Tit√£ de Magma", vida: 400 },
        historiaPosChefe: "üî• Emberforge foi libertada."
    },
    Stormreach: {
        historia: "Stormreach ‚Äì Cidade das Tempestades.",
        monstros: [
            { nome: "Elemental de Trov√£o", vida: 120 },
            { nome: "Raio Errante", vida: 180 }
        ],
        chefe: { nome: "Drag√£o El√©trico", vida: 360 },
        historiaPosChefe: "‚ö° Stormreach est√° em paz."
    },
    Shadowfen: {
        historia: "Shadowfen ‚Äì O covil final.",
        monstros: [
            { nome: "Sapo Gigante", vida: 90 },
            { nome: "Serpente Sombria", vida: 150 }
        ],
        chefe: { nome: "Lorde das Trevas", vida: 5000 },
        historiaPosChefe: "üëë O mundo foi salvo!"
    },
    Aethelburg: {
        historia: "Aethelburg ‚Äì A Capital, lar da Grande Biblioteca.",
        monstros: [],
        chefe: null,
        historiaPosChefe: null
    }
};

// -----------------------------
// Estado do jogo
// -----------------------------
let inimigoAtual = null;
let filaMonstros = [];
let chefeAtual = null;
let cidadeAtual = null;

// -----------------------------
// HTML
// -----------------------------
const out = document.getElementById("output");
const btnAtk = document.getElementById("atkBtn");
const btnMag = document.getElementById("magBtn");
const btnDef = document.getElementById("defBtn");
const btnFugir = document.getElementById("fugirBtn");
const btnMapa = document.getElementById("voltarBtn");
const mapaDiv = document.getElementById("mapa");

// -----------------------------
// Utilit√°rios
// -----------------------------
function log(msg) {
    out.insertAdjacentHTML("beforeend", msg + "<br>");
    out.scrollTop = out.scrollHeight;
}
function limpar() {
    out.innerHTML = "";
}
function mostraStatus() {
    log(`üë§ ${player.nome} | LVL ${player.nivel} | ‚ù§Ô∏è ${player.vida}/${player.maxVida} | üîÆ ${player.mana}/${player.maxMana}`);
}

// -----------------------------
// SAVE / LOAD
// -----------------------------
function salvarJogo() {
    const save = {
        player,
        cidadeAtual,
        filaMonstros,
        chefeAtual,
        inimigoAtual
    };
    localStorage.setItem("mundoMagiaSave", JSON.stringify(save));
    log("üíæ Jogo salvo!");
}

function carregarJogo() {
    const data = localStorage.getItem("mundoMagiaSave");
    if (!data) {
        log("‚ùå Nenhum save encontrado.");
        return;
    }

    const save = JSON.parse(data);
    Object.assign(player, save.player);
    cidadeAtual = save.cidadeAtual;
    filaMonstros = save.filaMonstros || [];
    chefeAtual = save.chefeAtual;
    inimigoAtual = save.inimigoAtual;

    limpar();
    log("üìÇ Jogo carregado!");
    mostraStatus();

    if (inimigoAtual) {
        iniciarCombate(inimigoAtual);
    } else if (cidadeAtual) {
        log(`üìç √öltima cidade: ${cidadeAtual}`);
    }
}

// -----------------------------
// Progress√£o
// -----------------------------
function subirNivel() {
    if (player.nivel >= LIMITES.MAX_LEVEL) return;
    player.nivel++;
    player.maxVida = Math.min(LIMITES.MAX_VIDA, player.maxVida + 10);
    player.maxMana = Math.min(LIMITES.MAX_MANA, player.maxMana + 2);
    player.vida = player.maxVida;
    player.mana = player.maxMana;
    log(`üåü Subiu para o n√≠vel ${player.nivel}!`);
}

// -----------------------------
// Combate
// -----------------------------
function iniciarCombate(monstro) {
    inimigoAtual = { ...monstro };
    limpar();
    log(`‚öîÔ∏è ${inimigoAtual.nome} apareceu! (${inimigoAtual.vida} HP)`);
    mostraStatus();
}

function atacar() {
    if (!inimigoAtual) return;
    const dano = Math.floor(Math.random() * 5) + player.ataque;
    inimigoAtual.vida -= dano;
    log(`üó°Ô∏è Voc√™ causou ${dano} de dano.`);
    if (inimigoAtual.vida <= 0) {
        log(`üéâ ${inimigoAtual.nome} derrotado!`);
        subirNivel();
        nextMonstro();
    }
}

function magia() {
    if (player.mana < 5 || !inimigoAtual) return;
    player.mana -= 5;
    const nomes = Object.keys(magias);
    const m = nomes[Math.floor(Math.random() * nomes.length)];
    inimigoAtual.vida -= magias[m];
    log(`‚ú® ${m} causou ${magias[m]} de dano!`);
    if (inimigoAtual.vida <= 0) {
        log(`üéâ ${inimigoAtual.nome} derrotado!`);
        subirNivel();
        nextMonstro();
    }
}

function defender() {
    if (!inimigoAtual) return;
    log("üõ°Ô∏è Voc√™ se defendeu!");
}

function fugir() {
    if (!inimigoAtual) return;
    if (Math.random() < 0.5) {
        log("üèÉ Voc√™ fugiu!");
        nextMonstro(true);
    } else {
        log("‚ùå Falha na fuga!");
    }
}

// -----------------------------
// Sequ√™ncia
// -----------------------------
function nextMonstro() {
    if (filaMonstros.length > 0) {
        iniciarCombate(filaMonstros.shift());
    } else if (chefeAtual) {
        iniciarCombate(chefeAtual);
        chefeAtual = null;
    } else {
        log(`üèÜ ${cidadeAtual} conclu√≠da!`);
    }
}

// -----------------------------
// Cidades
// -----------------------------
function visitarCidade(nome) {
    limpar();
    cidadeAtual = nome;
    log(`üèôÔ∏è ${cidades[nome].historia}`);
    mostraStatus();

    if (nome === "Aethelburg") {
        log("üìú O velho bibliotec√°rio diz: nem todo livro aqui quer ser lido... Alguns preferem observar.");
        return;
    }

    filaMonstros = [...cidades[nome].monstros];
    chefeAtual = cidades[nome].chefe ? { ...cidades[nome].chefe } : null;
    nextMonstro();
}

// -----------------------------
// Mapa
// -----------------------------
btnMapa.onclick = () => {
    limpar();
    log("üåç Escolha uma cidade:");
    mapaDiv.innerHTML = "";

    Object.keys(cidades).forEach(c => {
        const b = document.createElement("button");
        b.textContent = c;
        b.onclick = () => visitarCidade(c);
        mapaDiv.appendChild(b);
    });

    const saveBtn = document.createElement("button");
    saveBtn.textContent = "üíæ Salvar";
    saveBtn.onclick = salvarJogo;

    const loadBtn = document.createElement("button");
    loadBtn.textContent = "üìÇ Carregar";
    loadBtn.onclick = carregarJogo;

    mapaDiv.appendChild(saveBtn);
    mapaDiv.appendChild(loadBtn);
};

// -----------------------------
// Bot√µes
// -----------------------------
btnAtk.onclick = atacar;
btnMag.onclick = magia;
btnDef.onclick = defender;
btnFugir.onclick = fugir;

// -----------------------------
// In√≠cio
// -----------------------------
function iniciarJogo() {
    limpar();
    log("=== BEM-VINDO AO MUNDO DE MAGIA ===");
    mostraStatus();
}
iniciarJogo();

